# seqpack文档

## 目标<br>
seqpack是一款开源的，快速读取文件并减少存储空间的dna、氨基酸序列的存储文件格式工具。其提供的格式是`sp`格式。


## 一、技术规格与设计细节

### 1. 文件格式结构定义
```yaml
Header部分:
- 魔数:SPF1        -4字节   
- 版本号:xxx       -1字节  (0-256)
- 序列类型标识:x  -1字节（DNA:0/RNA:1/Protein:2）   
- 总序列数:x     -
- 编码方式（压缩算法标识）
- 索引表偏移量

Data部分:
- 序列长度信息（定长/变长标识）
- 序列数据块
- 可选的质量分数块
- 可选的元数据块

Index部分:
- 序列偏移量表
- 序列长度表（如果是变长）
- 可选：序列ID哈希表（用于快速查找）
```

### 2. 编码方案建议
```
考虑：
1. DNA序列：2-bit编码（A:00, C:01, G:10, T:11）
2. 氨基酸：5-bit编码（20种氨基酸+特殊字符）
3. 压缩算法：LZ4/Snappy（快速解压）或Zstd（高压缩比可选）
```

## 二、API设计示例

第一个是 c-api，ctypes
第二个是pybind

## 三、测试方案的细化

### 1. 基准测试矩阵
```
维度：
- 文件大小：1KB, 1MB, 10MB, 100MB, 1GB, 10GB
- 序列类型：DNA, RNA, Protein
- 序列长度：变长
- 读取模式：顺序读取、随机访问、批量查询
```

### 2. 安全测试
```
特殊字符序列（包含非ASCII字符）
超大序列长度(10^12)
文件损坏检测
```

### 3. 对比格式列表
```
必比：
- FASTA（基准）
- FASTQ（含质量分数）
- HDF5（h5py）
- NPZ（numpy压缩）
- Parquet（列式存储）

选比：
- Zarr（分块存储）
- Feather（Apache Arrow）
- LMDB（内存映射数据库）
```

### 4. 性能指标具体化
```python
测试指标 = {
    "写入时间": "从数据到磁盘的总时间",
    "读取时间": {
        "完整加载": "全部序列读入内存",
        "惰性加载": "仅加载索引",
        "随机访问": "读取单个序列的平均时间",
        "批量访问": "读取1000个序列的时间"
    },
    "压缩率": "文件大小 / 原始文本大小",
    "内存占用": {
        "峰值内存": "处理过程中的最大内存",
        "常驻内存": "保持打开状态的内存"
    },
    "并发性能": "多线程/多进程读取效率"
}
```

## 四、实施路线图建议

### Phase 1: MVP（最小可行产品）
1. 实现定长序列的读写
2. 支持DNA 2-bit编码
3. 基本的命令行工具

### Phase 2: 核心功能
1. 变长序列支持
2. 索引机制优化
3. 增删查改完整实现

### Phase 3: 高级特性
1. 质量分数存储
2. 元数据支持
3. 流式处理接口

### Phase 4: 生态集成
1. BioPython兼容接口
2. 多语言绑定（C/C++库）

## 五、需要考虑的技术决策

### 1. 内存映射 vs 缓冲读取
- 小文件：完整加载
- 大文件：内存映射分块

### 2. 索引策略
- 密集索引：每个序列都有索引项
- 稀疏索引：按块索引，块内线性查找

### 3. 并发安全
- 读取：完全并发
- 写入：文件锁机制
- 修改：COW（Copy-on-Write）策略

## 六、文档建议补充

### 1. 用例场景
```
- 单机大文件处理
- 服务器端序列数据库
- 深度学习训练数据格式
```

### 2. 兼容性考虑
- 向后兼容性保证
- 损坏文件恢复机制
- 与其他格式的转换工具

### 3. 社区建设
- 详细的贡献指南
- 性能对比报告模板

## 七、风险评估与缓解

### 潜在风险：
1. 压缩算法专利问题 → 使用开源算法
2. 大端小端问题 → 固定使用小端序
3. 文件损坏传播 → 添加checksum验证

### 质量控制：
1. Fuzzing测试：随机数据测试鲁棒性
2. 一致性验证：与FASTA双向转换验证
3. 压力测试：极限条件下的表现

